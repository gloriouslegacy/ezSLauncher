name: Build and Release

on:
  push:
    branches:
      - main
    tags:
      - "v*"

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # Determine version from tags
      - name: Determine version
        id: vars
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            base_version="${GITHUB_REF#refs/tags/v}"
            version="$base_version"
            release_name="$base_version"
          else
            version="0.0.0-dev-$(date +%Y%m%d)"
            base_version="0.0.0-dev"
            release_name="$version"
          fi
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "base_version=$base_version" >> $GITHUB_OUTPUT
          echo "release_name=$release_name" >> $GITHUB_OUTPUT

      # Verify icon files exist
      - name: Verify icon files
        shell: pwsh
        run: |
          Write-Host "=== Icon Files Check ==="
          if (Test-Path "./icon/icon.ico") {
            Write-Host "‚úì icon.ico found"
            $iconSize = (Get-Item "./icon/icon.ico").Length
            Write-Host "  Size: $iconSize bytes"
          } else {
            Write-Host "‚úó icon.ico NOT found"
            exit 1
          }
          
          if (Test-Path "./icon/icon_title.ico") {
            Write-Host "‚úì icon_title.ico found"
          } else {
            Write-Host "‚ö† icon_title.ico NOT found (optional)"
          }
          
          Write-Host "`n=== Language Files Check ==="
          if (Test-Path "./language/lang_ko.ini") {
            Write-Host "‚úì lang_ko.ini found"
            $langSize = (Get-Item "./language/lang_ko.ini").Length
            Write-Host "  Size: $langSize bytes"
          } else {
            Write-Host "‚ö† lang_ko.ini NOT found - Korean language will not be available"
          }
          
          Write-Host "`n=== Directory Structure ==="
          Get-ChildItem -Path . -Recurse -Include *.ico,*.ini | ForEach-Object {
            Write-Host "  $($_.FullName)"
          }

      # Install Python dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          if (Test-Path "requirements.txt") {
            pip install -r requirements.txt
          }
        shell: pwsh

      # Generate version_info.txt with auto-updated version
      - name: Generate version_info.txt
        shell: pwsh
        run: |
          $version = "${{ steps.vars.outputs.version }}"
          $versionParts = $version -replace '-.*','' -split '\.'
          
          # Pad version to 3 parts (e.g., 1.0 -> 1.0.0)
          while ($versionParts.Count -lt 3) {
            $versionParts += "0"
          }
          
          # filevers needs 4 parts (Windows requirement)
          $filevers = "($($versionParts[0]), $($versionParts[1]), $($versionParts[2]), 0)"
          # Display version uses 3 parts
          $versionStr = "$($versionParts[0]).$($versionParts[1]).$($versionParts[2])"
          
          $versionInfo = @"
          # UTF-8 encoding
          
          VSVersionInfo(
            ffi=FixedFileInfo(
              # File version
              filevers=$filevers,
              # Product version
              prodvers=$filevers,
              mask=0x3f,
              flags=0x0,
              OS=0x40004,
              fileType=0x1,
              subtype=0x0,
              date=(0, 0)
              ),
            kids=[
              StringFileInfo(
                [
                StringTable(
                  u'041204B0',
                  [
                  StringStruct(u'Comments', u'Advanced file search and launcher'),
                  StringStruct(u'CompanyName', u'ez'),
                  StringStruct(u'FileDescription', u'ezSLauncher - File Search & Launcher'),
                  StringStruct(u'FileVersion', u'$versionStr'),
                  StringStruct(u'InternalName', u'ezSLauncher.exe'),
                  StringStruct(u'LegalCopyright', u'Copyright ¬© 2025 ez All rights reserved.'),
                  StringStruct(u'LegalTrademarks', u''),
                  StringStruct(u'OriginalFilename', u'ezSLauncher.exe'),
                  StringStruct(u'ProductName', u'ezSLauncher'),
                  StringStruct(u'ProductVersion', u'$versionStr'),
                  StringStruct(u'SpecialBuild', u'')
                  ]
                )
                ]
              ),
              VarFileInfo([VarStruct(u'Translation', [0x0412, 1200])])
            ]
          )
          "@
          
          $versionInfo | Out-File -FilePath "version_info.txt" -Encoding UTF8
          
          Write-Host "=== Generated version_info.txt ==="
          Get-Content "version_info.txt"

      # Build PORTABLE version (single EXE with everything embedded)
      - name: Build Portable Version
        shell: pwsh
        run: |
          Write-Host "=== Building PORTABLE Version ==="
          
          $iconPath = "icon/icon.ico"
          Write-Host "Icon path: $iconPath"
          Write-Host "Icon exists: $(Test-Path 'icon\icon.ico')"
          
          # Check if lang_ko.ini exists
          if (Test-Path "language/lang_ko.ini") {
            Write-Host "‚úì lang_ko.ini found"
          } else {
            Write-Host "‚ö† lang_ko.ini NOT found - Korean language will not be available"
          }
          
          # PyInstaller for portable - everything in one EXE
          pyinstaller --onefile `
            --windowed `
            --name "ezSLauncher_Portable" `
            --clean `
            --version-file "version_info.txt" `
            --icon="$iconPath" `
            --add-data "icon;icon" `
            --add-data "language/lang_ko.ini;language" `
            ezSLauncher.py
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚úó Portable build failed with exit code $LASTEXITCODE"
            exit 1
          }
          
          Write-Host "‚úì Portable build completed"
          
          # Verify portable build
          if (Test-Path "dist/ezSLauncher_Portable.exe") {
            $size = (Get-Item "dist/ezSLauncher_Portable.exe").Length
            Write-Host "‚úì Portable EXE created: $($size / 1MB) MB"
          }

      # Build INSTALLER version (folder with separate files)
      - name: Build Installer Version
        shell: pwsh
        run: |
          Write-Host "=== Building INSTALLER Version ==="
          
          $iconPath = "icon/icon.ico"
          
          # Check if lang_ko.ini exists
          if (Test-Path "language/lang_ko.ini") {
            Write-Host "‚úì lang_ko.ini found"
          } else {
            Write-Host "‚ö† lang_ko.ini NOT found - Korean language will not be available"
          }
          
          # Clean previous build
          if (Test-Path "build") { Remove-Item -Recurse -Force "build" }
          
          # PyInstaller for installer - separate files in folder
          pyinstaller --onedir `
            --windowed `
            --name "ezSLauncher" `
            --clean `
            --version-file "version_info.txt" `
            --icon="$iconPath" `
            --add-data "icon;icon" `
            --add-data "language/lang_ko.ini;language" `
            ezSLauncher.py
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚úó Installer build failed with exit code $LASTEXITCODE"
            exit 1
          }
          
          Write-Host "‚úì Installer build completed"
          
          # Verify installer build
          if (Test-Path "dist/ezSLauncher/ezSLauncher.exe") {
            $size = (Get-Item "dist/ezSLauncher/ezSLauncher.exe").Length
            Write-Host "‚úì Installer EXE created: $($size / 1MB) MB"
            
            Write-Host "`n=== Installer Contents ==="
            Get-ChildItem "dist/ezSLauncher" -Recurse | Format-Table Name, Length
            
            # Verify lang_ko.ini is included
            if (Test-Path "dist/ezSLauncher/language/lang_ko.ini") {
              Write-Host "‚úì lang_ko.ini included in installer"
            } else {
              Write-Host "‚ö† lang_ko.ini NOT found in installer"
            }
          }

      # Install Inno Setup
      - name: Install Inno Setup
        shell: pwsh
        run: |
          Write-Host "=== Installing Inno Setup ==="
          
          # Download Inno Setup
          $innoUrl = "https://jrsoftware.org/download.php/is.exe"
          $innoInstaller = "innosetup-installer.exe"
          
          Write-Host "Downloading Inno Setup..."
          Invoke-WebRequest -Uri $innoUrl -OutFile $innoInstaller
          
          # Install silently
          Write-Host "Installing Inno Setup..."
          Start-Process -FilePath $innoInstaller -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART /SP-" -Wait
          
          # Verify installation
          $isccPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          if (Test-Path $isccPath) {
            Write-Host "‚úì Inno Setup installed successfully"
            Write-Host "ISCC path: $isccPath"
          } else {
            Write-Host "‚úó Inno Setup installation failed"
            Write-Host "Expected path: $isccPath"
            Write-Host "Searching for ISCC.exe..."
            Get-ChildItem "C:\Program Files (x86)" -Recurse -Filter "ISCC.exe" -ErrorAction SilentlyContinue | Format-Table FullName
            exit 1
          }

      # Create Inno Setup Script
      - name: Create Inno Setup Script
        shell: pwsh
        run: |
          Write-Host "=== Creating Inno Setup Script ==="
          
          $version = "${{ steps.vars.outputs.version }}"
          $versionClean = $version -replace '-.*',''
          
          # Check what files exist in the build output
          Write-Host "`n=== Checking build output ==="
          Write-Host "Main executable:"
          if (Test-Path "dist\ezSLauncher\ezSLauncher.exe") {
            Write-Host "‚úì ezSLauncher.exe found"
          } else {
            Write-Host "‚úó ezSLauncher.exe NOT found"
          }
          
          Write-Host "`nLanguage file:"
          if (Test-Path "dist\ezSLauncher\language\lang_ko.ini") {
            Write-Host "‚úì lang_ko.ini found"
          } else {
            Write-Host "‚úó lang_ko.ini NOT found"
          }
          
          Write-Host "`nIcon folder:"
          if (Test-Path "dist\ezSLauncher\icon") {
            Write-Host "‚úì icon folder found"
            Get-ChildItem "dist\ezSLauncher\icon" | Format-Table Name
          } else {
            Write-Host "‚ö† icon folder NOT found - will use fallback"
          }
          
          Write-Host "`n_internal folder:"
          if (Test-Path "dist\ezSLauncher\_internal") {
            Write-Host "‚úì _internal folder found"
          } else {
            Write-Host "‚ö† _internal folder NOT found"
          }
          
          # Create ISS file using array of lines
          $issLines = @(
            "; ezSLauncher Inno Setup Script",
            "; Creates Windows installer with setup wizard",
            "",
            "#define MyAppName `"ezSLauncher`"",
            "#define MyAppVersion `"$versionClean`"",
            "#define MyAppPublisher `"ez`"",
            "#define MyAppURL `"https://github.com/gloriouslegacy/ezSLauncher`"",
            "#define MyAppExeName `"ezSLauncher.exe`"",
            "",
            "[Setup]",
            "; App information",
            "AppId={{E7A5C4B2-8D9F-4E3A-9B2C-1F6D8A4E5B3C}",
            "AppName={#MyAppName}",
            "AppVersion={#MyAppVersion}",
            "AppVerName={#MyAppName} {#MyAppVersion}",
            "AppPublisher={#MyAppPublisher}",
            "AppPublisherURL={#MyAppURL}",
            "AppSupportURL={#MyAppURL}",
            "AppUpdatesURL={#MyAppURL}",
            "",
            "; Installation directories",
            "DefaultDirName={autopf}\{#MyAppName}",
            "DefaultGroupName={#MyAppName}",
            "DisableProgramGroupPage=yes",
            "",
            "; Output",
            "OutputDir=installer_output",
            "OutputBaseFilename=ezSLauncher_Setup_{#MyAppVersion}",
            "",
            "; Compression",
            "Compression=lzma2",
            "SolidCompression=yes",
            "",
            "; Windows version requirement",
            "MinVersion=10.0.19041",
            "",
            "; Privileges",
            "PrivilegesRequired=admin",
            "PrivilegesRequiredOverridesAllowed=dialog",
            "",
            "; UI settings",
            "WizardStyle=modern",
            "UninstallDisplayIcon={app}\{#MyAppExeName}",
            "",
            "[Languages]",
            "Name: `"english`"; MessagesFile: `"compiler:Default.isl`"",
            "",
            "[Tasks]",
            "Name: `"desktopicon`"; Description: `"Create a desktop shortcut`"; GroupDescription: `"Additional shortcuts:`"; Flags: unchecked",
            "",
            "[Files]",
            "; Main executable",
            "Source: `"dist\ezSLauncher\ezSLauncher.exe`"; DestDir: `"{app}`"; Flags: ignoreversion",
            "",
            "; Language file (optional)",
            "Source: `"dist\ezSLauncher\language\lang_ko.ini`"; DestDir: `"{app}\language`"; Flags: ignoreversion skipifsourcedoesntexist",
            "",
            "; Icon folder (optional)",
            "Source: `"dist\ezSLauncher\icon\*`"; DestDir: `"{app}\icon`"; Flags: ignoreversion recursesubdirs createallsubdirs skipifsourcedoesntexist",
            "",
            "; Internal dependencies",
            "Source: `"dist\ezSLauncher\_internal\*`"; DestDir: `"{app}\_internal`"; Flags: ignoreversion recursesubdirs createallsubdirs",
            "",
            "[Icons]",
            "; Start Menu shortcuts",
            "Name: `"{group}\{#MyAppName}`"; Filename: `"{app}\{#MyAppExeName}`"",
            "Name: `"{group}\Uninstall {#MyAppName}`"; Filename: `"{uninstallexe}`"",
            "",
            "; Desktop shortcut",
            "Name: `"{autodesktop}\{#MyAppName}`"; Filename: `"{app}\{#MyAppExeName}`"; Tasks: desktopicon",
            "",
            "[Run]",
            "; Option to run after installation",
            "Filename: `"{app}\{#MyAppExeName}`"; Description: `"Launch {#MyAppName}`"; Flags: nowait postinstall skipifsilent",
            "",
            "[UninstallDelete]",
            "; Clean up config files on uninstall",
            "Type: files; Name: `"{app}\app_config.json`"",
            "Type: dirifempty; Name: `"{app}`""
          )
          
          # Save ISS file
          $issLines | Out-File -FilePath "ezSLauncher_setup.iss" -Encoding UTF8
          
          Write-Host "`n‚úì ISS file created"
          Write-Host "Version: $versionClean"
          Write-Host "`n=== ISS File Content ==="
          Get-Content "ezSLauncher_setup.iss"

      # Create Windows Installer with Setup Wizard
      - name: Create Setup Wizard Installer
        shell: pwsh
        run: |
          Write-Host "=== Creating Setup Wizard Installer ==="
          
          # Verify ISS file exists
          if (-not (Test-Path "ezSLauncher_setup.iss")) {
            Write-Host "‚úó ezSLauncher_setup.iss not found"
            exit 1
          }
          
          Write-Host "‚úì ISS file found"
          
          # Verify build output exists
          if (-not (Test-Path "dist/ezSLauncher/ezSLauncher.exe")) {
            Write-Host "‚úó dist/ezSLauncher/ezSLauncher.exe not found"
            Write-Host "Build output directory contents:"
            Get-ChildItem "dist" -Recurse | Format-Table FullName
            exit 1
          }
          
          Write-Host "‚úì Build output verified"
          
          # List files that will be included
          Write-Host "`n=== Files to be included in installer ==="
          Write-Host "Main executable:"
          Get-Item "dist/ezSLauncher/ezSLauncher.exe" | Format-Table Name, Length
          
          Write-Host "`nLanguage file:"
          if (Test-Path "dist/ezSLauncher/language/lang_ko.ini") {
            Get-Item "dist/ezSLauncher/language/lang_ko.ini" | Format-Table Name, Length
          } else {
            Write-Host "‚ö† lang_ko.ini not found"
          }
          
          Write-Host "`nIcon folder:"
          if (Test-Path "dist/ezSLauncher/icon") {
            Get-ChildItem "dist/ezSLauncher/icon" | Format-Table Name, Length
          } else {
            Write-Host "‚ö† icon folder not found"
          }
          
          # Compile with Inno Setup
          $isccPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          
          if (-not (Test-Path $isccPath)) {
            Write-Host "‚úó Inno Setup compiler not found at: $isccPath"
            exit 1
          }
          
          Write-Host "`nCompiling installer with Inno Setup..."
          Write-Host "Compiler: $isccPath"
          Write-Host "Script: ezSLauncher_setup.iss"
          Write-Host "Working directory: $PWD"
          
          # Run ISCC
          & $isccPath "ezSLauncher_setup.iss"
          
          $exitCode = $LASTEXITCODE
          Write-Host "ISCC exit code: $exitCode"
          
          if ($exitCode -ne 0) {
            Write-Host "‚úó Inno Setup compilation failed with exit code: $exitCode"
            Write-Host "`n=== Checking for error logs ==="
            Get-ChildItem -Filter "*.log" | ForEach-Object {
              Write-Host "`nLog file: $($_.Name)"
              Get-Content $_.FullName
            }
            exit 1
          }
          
          Write-Host "‚úì Compilation completed successfully"
          
          # Verify output directory
          if (-not (Test-Path "installer_output")) {
            Write-Host "‚ö† installer_output directory not created"
            Write-Host "Searching for setup files..."
            Get-ChildItem -Filter "*.exe" -Recurse | Where-Object { $_.Name -like "*Setup*" } | Format-Table FullName, Length
            exit 1
          }
          
          # Find setup file
          $setupFile = Get-ChildItem "installer_output" -Filter "ezSLauncher_Setup_*.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          
          if ($setupFile) {
            $size = $setupFile.Length / 1MB
            Write-Host "‚úì Setup file created: $($setupFile.Name)"
            Write-Host "  Size: $([math]::Round($size, 2)) MB"
            Write-Host "  Path: $($setupFile.FullName)"
            
            # Copy to root with simpler name
            Copy-Item $setupFile.FullName -Destination "ezSLauncher_Setup.exe"
            Write-Host "‚úì Copied to: ezSLauncher_Setup.exe"
          } else {
            Write-Host "‚úó Setup file not found in installer_output"
            Write-Host "`nContents of installer_output:"
            Get-ChildItem "installer_output" | Format-Table Name, Length
            exit 1
          }

      # Verify built executables
      - name: Verify Built Executables
        shell: pwsh
        run: |
          Write-Host "=== Verifying Built Executables ==="
          
          # Check Portable
          if (Test-Path "dist/ezSLauncher_Portable.exe") {
            $exeSize = (Get-Item "dist/ezSLauncher_Portable.exe").Length
            Write-Host "‚úì Portable EXE: $($exeSize / 1MB) MB"
            
            try {
              Add-Type -AssemblyName System.Drawing
              $icon = [System.Drawing.Icon]::ExtractAssociatedIcon("$PWD\dist\ezSLauncher_Portable.exe")
              if ($icon) {
                Write-Host "‚úì Portable icon verified: $($icon.Width)x$($icon.Height)"
                $icon.Dispose()
              }
            } catch {
              Write-Host "‚ö† Could not verify portable icon: $($_.Exception.Message)"
            }
          } else {
            Write-Host "‚úó Portable EXE not found"
            exit 1
          }
          
          # Check Installer
          if (Test-Path "dist/ezSLauncher/ezSLauncher.exe") {
            $exeSize = (Get-Item "dist/ezSLauncher/ezSLauncher.exe").Length
            Write-Host "‚úì Installer EXE: $($exeSize / 1MB) MB"
            
            try {
              Add-Type -AssemblyName System.Drawing
              $icon = [System.Drawing.Icon]::ExtractAssociatedIcon("$PWD\dist\ezSLauncher\ezSLauncher.exe")
              if ($icon) {
                Write-Host "‚úì Installer icon verified: $($icon.Width)x$($icon.Height)"
                $icon.Dispose()
              }
            } catch {
              Write-Host "‚ö† Could not verify installer icon: $($_.Exception.Message)"
            }
          } else {
            Write-Host "‚úó Installer EXE not found"
            exit 1
          }

      # Generate file hashes
      - name: Generate File Hashes
        shell: pwsh
        run: |
          Write-Host "=== File Hashes ==="
          
          $portableHash = Get-FileHash -Path "dist/ezSLauncher_Portable.exe" -Algorithm SHA256
          Write-Host "Portable SHA256: $($portableHash.Hash)"
          
          $installerHash = Get-FileHash -Path "dist/ezSLauncher/ezSLauncher.exe" -Algorithm SHA256
          Write-Host "Installer SHA256: $($installerHash.Hash)"
          
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value @"
          ## Build Info
          
          ### Portable Version
          - SHA256: ``$($portableHash.Hash)``
          - [VirusTotal Scan](https://www.virustotal.com/gui/file/$($portableHash.Hash))
          
          ### Installer Version
          - SHA256: ``$($installerHash.Hash)``
          - [VirusTotal Scan](https://www.virustotal.com/gui/file/$($installerHash.Hash))
          "@

      # Prepare release packages
      - name: Prepare Release Packages
        shell: pwsh
        run: |
          Write-Host "=== Preparing Release Packages ==="
          
          # Create release directory
          New-Item -ItemType Directory -Force -Path "release"
          
          # Package Portable version
          Write-Host "Packaging Portable..."
          Copy-Item "dist/ezSLauncher_Portable.exe" "release/"
          
          # Copy lang_ko.ini to release folder for portable version
          if (Test-Path "language/lang_ko.ini") {
            Copy-Item "language/lang_ko.ini" "release/"
            Write-Host "‚úì lang_ko.ini added to portable package"
          }
          
          if (Test-Path "README.md") { Copy-Item "README.md" "release/README_Portable.txt" }
          if (Test-Path "LICENSE") { Copy-Item "LICENSE" "release/" }
          
          # Create README for portable
          @"
          ezSLauncher - Portable Version
          
          This is the portable version in a single executable file.
          
          Files included:
          - ezSLauncher_Portable.exe (main program)
          - lang_ko.ini (Korean language file - must be in same folder as EXE)
          - README_Portable.txt (this file)
          
          To run:
          1. Place all files in the same folder
          2. Run ezSLauncher_Portable.exe
          
          Language Support:
          - English is built-in (default)
          - Korean requires lang_ko.ini file in the same folder as the EXE
          - To switch language: Menu ‚Üí Language ‚Üí ÌïúÍµ≠Ïñ¥
          
          For an installer with setup wizard, download ezSLauncher_Setup.exe instead.
          "@ | Out-File -FilePath "release/README_Portable.txt" -Encoding UTF8
          
          Compress-Archive -Path "release/*" -DestinationPath "ezSLauncher_Portable.zip" -Force
          
          Write-Host "‚úì Portable package created"
          Write-Host "  Contents: ezSLauncher_Portable.exe, lang_ko.ini, README_Portable.txt"
          
          # Package Manual Install version (ZIP)
          Write-Host "Packaging Manual Install ZIP..."
          Remove-Item "release/*" -Force -ErrorAction SilentlyContinue
          
          Copy-Item -Path "dist/ezSLauncher/*" -Destination "release/" -Recurse
          if (Test-Path "README.md") { Copy-Item "README.md" "release/README.txt" }
          if (Test-Path "LICENSE") { Copy-Item "LICENSE" "release/" }
          
          # Create README for manual install
          @"
          ezSLauncher - Manual Install Version
          
          This is the manual installation version with all files in a folder.
          
          To install:
          1. Extract all files to a folder (e.g., C:\Program Files\ezSLauncher)
          2. Run ezSLauncher.exe
          3. (Optional) Create a shortcut on your desktop
          
          Language Support:
          - English is built-in (default)
          - Korean requires lang_ko.ini file (included in this package)
          - To switch language: Menu ‚Üí Language ‚Üí ÌïúÍµ≠Ïñ¥
          
          For easier installation with setup wizard, download ezSLauncher_Setup.exe instead.
          "@ | Out-File -FilePath "release/README_MANUAL.txt" -Encoding UTF8
          
          Compress-Archive -Path "release/*" -DestinationPath "ezSLauncher_Manual.zip" -Force
          
          Write-Host "‚úì Manual install package created"
          
          # Setup wizard installer is already created (ezSLauncher_Setup.exe)
          if (Test-Path "ezSLauncher_Setup.exe") {
            Write-Host "‚úì Setup wizard installer available"
            $setupSize = (Get-Item "ezSLauncher_Setup.exe").Length / 1MB
            Write-Host "  Size: $([math]::Round($setupSize, 2)) MB"
          }
          
          Write-Host "`n=== Package Sizes ==="
          $portableSize = (Get-Item "ezSLauncher_Portable.zip").Length / 1MB
          $manualSize = (Get-Item "ezSLauncher_Manual.zip").Length / 1MB
          Write-Host "Portable ZIP: $([math]::Round($portableSize, 2)) MB"
          Write-Host "Manual ZIP: $([math]::Round($manualSize, 2)) MB"
          if (Test-Path "ezSLauncher_Setup.exe") {
            $setupSize = (Get-Item "ezSLauncher_Setup.exe").Length / 1MB
            Write-Host "Setup Wizard: $([math]::Round($setupSize, 2)) MB"
          }
          
          Write-Host "`n=== Verifying Package Contents ==="
          Write-Host "Portable ZIP contents:"
          Expand-Archive -Path "ezSLauncher_Portable.zip" -DestinationPath "temp_verify_portable" -Force
          Get-ChildItem "temp_verify_portable" | Format-Table Name, Length
          Remove-Item -Recurse -Force "temp_verify_portable"
          
          Write-Host "`nManual ZIP contents:"
          Expand-Archive -Path "ezSLauncher_Manual.zip" -DestinationPath "temp_verify_manual" -Force
          Get-ChildItem "temp_verify_manual" -Recurse | Where-Object { $_.Name -match '\.(exe|ini|txt)$' } | Format-Table Name, Length
          Remove-Item -Recurse -Force "temp_verify_manual"

      # Create GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.vars.outputs.base_version }}
          name: Release ${{ steps.vars.outputs.release_name }}
          body: |
            # üì¶ ezSLauncher v${{ steps.vars.outputs.release_name }}
            
            Advanced file search and launcher with regex support.

            ## üìù Changelog

            See commit history for detailed changes.

          files: |
            ezSLauncher_Setup.exe
            ezSLauncher_Portable.zip
            ezSLauncher_Manual.zip
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}