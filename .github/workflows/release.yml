name: Build and Release (Icon Guaranteed)

on:
  push:
    branches:
      - main
    tags:
      - "v*"

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # ÌÉúÍ∑∏ÏóêÏÑú Î≤ÑÏ†Ñ Ï∂îÏ∂ú
      - name: Determine version
        id: vars
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            base_version="${GITHUB_REF#refs/tags/v}"
            version="$base_version"
            release_name="$base_version"
          else
            version="0.0.0-dev-$(date +%Y%m%d)"
            base_version="0.0.0-dev"
            release_name="$version"
          fi
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "base_version=$base_version" >> $GITHUB_OUTPUT
          echo "release_name=$release_name" >> $GITHUB_OUTPUT

      # Python ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt
        shell: pwsh

      # Pillow ÏÑ§Ïπò (ÏïÑÏù¥ÏΩò Î≥ÄÌôòÏö©)
      - name: Install Pillow for icon conversion
        run: pip install Pillow
        shell: pwsh

      # ÏïÑÏù¥ÏΩò ÌååÏùº Í≤ÄÏ¶ù Î∞è Ï§ÄÎπÑ
      - name: Verify and prepare icon
        shell: pwsh
        run: |
          Write-Host "=== Icon Verification ==="
          
          $iconPath = "icon\icon.ico"
          
          if (-not (Test-Path $iconPath)) {
            Write-Host "[ERROR] Icon file not found: $iconPath"
            exit 1
          }
          
          $iconFile = Get-Item $iconPath
          Write-Host "[OK] Icon file found"
          Write-Host "  Path: $($iconFile.FullName)"
          Write-Host "  Size: $($iconFile.Length) bytes"
          
          # ÏïÑÏù¥ÏΩò ÌååÏùºÏù¥ Ïú†Ìö®ÌïúÏßÄ ÌôïÏù∏
          if ($iconFile.Length -eq 0) {
            Write-Host "[ERROR] Icon file is empty!"
            exit 1
          }
          
          if ($iconFile.Length -lt 100) {
            Write-Host "[WARNING] Icon file is suspiciously small"
          }
          
          # ÏïÑÏù¥ÏΩò ÌååÏùº Î≥µÏÇ¨ (Ï†àÎåÄ Í≤ΩÎ°ú Î≥¥Ïû•)
          $buildDir = Get-Location
          $targetIcon = Join-Path $buildDir "app_icon.ico"
          Copy-Item $iconPath $targetIcon -Force
          Write-Host "[OK] Icon copied to: $targetIcon"
          
          if (Test-Path "icon\icon_title.ico") {
            $targetIconTitle = Join-Path $buildDir "app_icon_title.ico"
            Copy-Item "icon\icon_title.ico" $targetIconTitle -Force
            Write-Host "[OK] Title icon copied to: $targetIconTitle"
          }

      # version_info.txt ÏÉùÏÑ±
      - name: Generate version_info.txt
        shell: pwsh
        run: |
          $version = "${{ steps.vars.outputs.version }}"
          $versionParts = $version -replace '-.*','' -split '\.'
          
          while ($versionParts.Count -lt 3) {
            $versionParts += "0"
          }
          
          $filevers = "($($versionParts[0]), $($versionParts[1]), $($versionParts[2]), 0)"
          $versionStr = "$($versionParts[0]).$($versionParts[1]).$($versionParts[2])"
          
          $versionInfo = @"
          # UTF-8
          
          VSVersionInfo(
            ffi=FixedFileInfo(
              filevers=$filevers,
              prodvers=$filevers,
              mask=0x3f,
              flags=0x0,
              OS=0x40004,
              fileType=0x1,
              subtype=0x0,
              date=(0, 0)
              ),
            kids=[
              StringFileInfo(
                [
                StringTable(
                  u'041204B0',
                  [
                  StringStruct(u'Comments', u''),
                  StringStruct(u'CompanyName', u'ez'),
                  StringStruct(u'FileDescription', u'ezSLauncher'),
                  StringStruct(u'FileVersion', u'$versionStr'),
                  StringStruct(u'InternalName', u'ezSLauncher.exe'),
                  StringStruct(u'LegalCopyright', u'Copyright ¬© 2025 ez All rights reserved.'),
                  StringStruct(u'LegalTrademarks', u''),
                  StringStruct(u'OriginalFilename', u'ezSLauncher.exe'),
                  StringStruct(u'ProductName', u'ezSLauncher'),
                  StringStruct(u'ProductVersion', u'$versionStr'),
                  StringStruct(u'SpecialBuild', u'')
                  ]
                )
                ]
              ),
              VarFileInfo([VarStruct(u'Translation', [0x0412, 1200])])
            ]
          )
          "@
          
          $versionInfo | Out-File -FilePath "version_info.txt" -Encoding UTF8

      # PyInstallerÎ°ú ÎπåÎìú (Î™ÖÎ†πÏ§ÑÏóêÏÑú ÏßÅÏ†ë)
      - name: Build with PyInstaller
        shell: pwsh
        run: |
          Write-Host "=== Building EXE with PyInstaller ==="
          
          $currentDir = Get-Location
          $iconPath = Join-Path $currentDir "app_icon.ico"
          $iconTitlePath = Join-Path $currentDir "app_icon_title.ico"
          
          Write-Host "Current directory: $currentDir"
          Write-Host "Icon path: $iconPath"
          Write-Host "Icon exists: $(Test-Path $iconPath)"
          
          # PyInstaller Î™ÖÎ†π Ïã§Ìñâ
          $cmd = @"
          pyinstaller --onefile --windowed --name "ezSLauncher" --clean --noupx --uac-admin --version-file "version_info.txt" --icon "$iconPath" --add-data "$iconTitlePath;icon" "ezSLauncher.py"
          "@
          
          Write-Host "`nExecuting command:"
          Write-Host $cmd
          
          Invoke-Expression $cmd
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "[ERROR] PyInstaller failed with exit code: $LASTEXITCODE"
            exit 1
          }
          
          Write-Host "[SUCCESS] PyInstaller build completed"

      # EXE ÏïÑÏù¥ÏΩò Ïû¨ÌôïÏù∏ Î∞è Í∞ïÏ†ú Ï£ºÏûÖ (rcedit ÏÇ¨Ïö©)
      - name: Force inject icon with rcedit
        shell: pwsh
        run: |
          Write-Host "=== Force icon injection ==="
          
          # rcedit Îã§Ïö¥Î°úÎìú
          Write-Host "Downloading rcedit..."
          try {
            Invoke-WebRequest -Uri "https://github.com/electron/rcedit/releases/download/v1.1.1/rcedit-x64.exe" -OutFile "rcedit.exe" -ErrorAction Stop
            Write-Host "[OK] rcedit downloaded"
          } catch {
            Write-Host "[WARNING] Could not download rcedit: $_"
            Write-Host "Skipping icon injection (icon should already be embedded by PyInstaller)"
            exit 0
          }
          
          $exePath = "dist\ezSLauncher.exe"
          $iconPath = "app_icon.ico"
          
          if (-not (Test-Path $exePath)) {
            Write-Host "[ERROR] EXE not found: $exePath"
            exit 1
          }
          
          if (-not (Test-Path $iconPath)) {
            Write-Host "[ERROR] Icon not found: $iconPath"
            exit 0
          }
          
          # Î∞±ÏóÖ
          Copy-Item $exePath "$exePath.bak" -Force
          
          # rceditÎ°ú ÏïÑÏù¥ÏΩò Ï£ºÏûÖ
          Write-Host "Injecting icon into EXE..."
          & .\rcedit.exe "$exePath" --set-icon "$iconPath"
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host "[SUCCESS] Icon injected with rcedit"
            Remove-Item "$exePath.bak" -Force
          } else {
            Write-Host "[WARNING] rcedit failed (exit code: $LASTEXITCODE)"
            Write-Host "Restoring original EXE (should have icon from PyInstaller)"
            Move-Item "$exePath.bak" $exePath -Force
          }

      # EXE Í≤ÄÏ¶ù
      - name: Verify EXE
        shell: pwsh
        run: |
          Write-Host "=== EXE Verification ==="
          
          $exePath = "dist\ezSLauncher.exe"
          
          if (Test-Path $exePath) {
            $exeFile = Get-Item $exePath
            Write-Host "[SUCCESS] EXE created"
            Write-Host "  Name: $($exeFile.Name)"
            Write-Host "  Size: $($exeFile.Length) bytes ($([math]::Round($exeFile.Length/1MB, 2)) MB)"
            Write-Host "  Created: $($exeFile.CreationTime)"
            Write-Host "  Modified: $($exeFile.LastWriteTime)"
            
            # ÌååÏùº ÌÅ¨Í∏∞ Í≤ÄÏ¶ù
            if ($exeFile.Length -lt 5MB) {
              Write-Host "[WARNING] EXE is smaller than expected"
            } elseif ($exeFile.Length -gt 50MB) {
              Write-Host "[WARNING] EXE is larger than expected"
            } else {
              Write-Host "[OK] EXE size is normal"
            }
          } else {
            Write-Host "[ERROR] EXE not found!"
            exit 1
          }

      # ÌååÏùº Ìï¥Ïãú
      - name: Generate file hash
        shell: pwsh
        run: |
          $hash = Get-FileHash -Path "dist/ezSLauncher.exe" -Algorithm SHA256
          Write-Host "SHA256: $($hash.Hash)"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "## Build Info`n- SHA256: ``$($hash.Hash)```n- File size: $('{0:N2}' -f ((Get-Item 'dist/ezSLauncher.exe').Length / 1MB)) MB`n- [VirusTotal Scan](https://www.virustotal.com/gui/file/$($hash.Hash))"

      # Î¶¥Î¶¨Ïä§ Ìå®ÌÇ§ÏßÄ Ï§ÄÎπÑ
      - name: Prepare release package
        shell: pwsh
        run: |
          Write-Host "=== Preparing release ==="
          
          New-Item -ItemType Directory -Force -Path release | Out-Null
          Copy-Item dist/ezSLauncher.exe release/ -Force
          
          if (Test-Path "README.md") {
            Copy-Item README.md release/ -Force
            Write-Host "[OK] README.md included"
          }
          
          if (Test-Path "LICENSE") {
            Copy-Item LICENSE release/ -Force
            Write-Host "[OK] LICENSE included"
          }
          
          Compress-Archive -Path release/* -DestinationPath ezSLauncher.zip -Force
          
          $zipFile = Get-Item ezSLauncher.zip
          Write-Host "[SUCCESS] Release package created"
          Write-Host "  File: $($zipFile.Name)"
          Write-Host "  Size: $($zipFile.Length) bytes ($([math]::Round($zipFile.Length/1MB, 2)) MB)"

      # GitHub Release ÏÉùÏÑ±
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.vars.outputs.base_version }}
          name: Release ${{ steps.vars.outputs.release_name }}
          body: |
            üì¶ **ezSLauncher v${{ steps.vars.outputs.release_name }}**

            ## üì• Download
            **ezSLauncher.zip** - Windows executable with icon

            ## üöÄ Installation
            1. Download the ZIP file
            2. Extract all files
            3. Run `ezSLauncher.exe`

            ## ‚ö†Ô∏è Important Notes
            - **Windows Defender**: May show a warning (click "More info" ‚Üí "Run anyway")
            - **Administrator**: Required for some operations
            - **First Launch**: May take a few seconds

            ## ‚ú® Build Details
            - Python 3.11
            - PyInstaller with --noupx (no UPX compression)
            - Icon embedded using dual method (PyInstaller + rcedit)
            - Version info included

            ## üîí Security
            - Open source project
            - SHA256 hash provided below
            - Scan with VirusTotal for verification

            ## üìù Changelog
            - Fixed PKG archive loading error
            - Ensured icon is properly embedded
            - Improved stability

            ---
            
            **Note**: If you see "PKG archive" error, please download this new version.
          files: |
            ezSLauncher.zip
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}