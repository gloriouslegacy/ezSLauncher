name: Build and Release (with Icon Post-Processing)

on:
  push:
    branches:
      - main
    tags:
      - "v*"

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # íƒœê·¸ì—ì„œ ë²„ì „ ì¶”ì¶œ
      - name: Determine version
        id: vars
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            base_version="${GITHUB_REF#refs/tags/v}"
            version="$base_version"
            release_name="$base_version"
          else
            version="0.0.0-dev-$(date +%Y%m%d)"
            base_version="0.0.0-dev"
            release_name="$version"
          fi
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "base_version=$base_version" >> $GITHUB_OUTPUT
          echo "release_name=$release_name" >> $GITHUB_OUTPUT

      # Python ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt
        shell: pwsh

      # ResourceHacker ë‹¤ìš´ë¡œë“œ (ì•„ì´ì½˜ ê°•ì œ ì£¼ì…ìš©)
      - name: Download ResourceHacker
        shell: pwsh
        run: |
          Write-Host "Downloading ResourceHacker..."
          Invoke-WebRequest -Uri "http://www.angusj.com/resourcehacker/resource_hacker.zip" -OutFile "rh.zip"
          Expand-Archive -Path "rh.zip" -DestinationPath "ResourceHacker"
          Write-Host "ResourceHacker downloaded and extracted"

      # ì•„ì´ì½˜ íŒŒì¼ ì¡´ì¬ í™•ì¸
      - name: Check icon files
        shell: pwsh
        run: |
          Write-Host "=== Checking icon files ==="
          if (Test-Path "icon/icon.ico") {
            Write-Host "[OK] icon/icon.ico exists"
            $iconFile = Get-Item "icon/icon.ico"
            Write-Host "Size: $($iconFile.Length) bytes"
          } else {
            Write-Host "[ERROR] icon/icon.ico NOT FOUND!"
            exit 1
          }

      # version_info.txt ìƒì„±
      - name: Generate version_info.txt
        shell: pwsh
        run: |
          $version = "${{ steps.vars.outputs.version }}"
          $versionParts = $version -replace '-.*','' -split '\.'
          
          while ($versionParts.Count -lt 3) {
            $versionParts += "0"
          }
          
          $filevers = "($($versionParts[0]), $($versionParts[1]), $($versionParts[2]), 0)"
          $versionStr = "$($versionParts[0]).$($versionParts[1]).$($versionParts[2])"
          
          $versionInfo = @"
          # UTF-8ë¡œ ì €ì¥
          
          VSVersionInfo(
            ffi=FixedFileInfo(
              filevers=$filevers,
              prodvers=$filevers,
              mask=0x3f,
              flags=0x0,
              OS=0x40004,
              fileType=0x1,
              subtype=0x0,
              date=(0, 0)
              ),
            kids=[
              StringFileInfo(
                [
                StringTable(
                  u'041204B0',
                  [
                  StringStruct(u'Comments', u''),
                  StringStruct(u'CompanyName', u'ez'),
                  StringStruct(u'FileDescription', u'ezSLauncher'),
                  StringStruct(u'FileVersion', u'$versionStr'),
                  StringStruct(u'InternalName', u'ezSLauncher.exe'),
                  StringStruct(u'LegalCopyright', u'Copyright Â© 2025 ez All rights reserved.'),
                  StringStruct(u'LegalTrademarks', u''),
                  StringStruct(u'OriginalFilename', u'ezSLauncher.exe'),
                  StringStruct(u'ProductName', u'ezSLauncher'),
                  StringStruct(u'ProductVersion', u'$versionStr'),
                  StringStruct(u'SpecialBuild', u'')
                  ]
                )
                ]
              ),
              VarFileInfo([VarStruct(u'Translation', [0x0412, 1200])])
            ]
          )
          "@
          
          $versionInfo | Out-File -FilePath "version_info.txt" -Encoding UTF8

      # PyInstallerë¡œ ë¹Œë“œ (ì¼ë‹¨ ì•„ì´ì½˜ ì—†ì´ ë˜ëŠ” ìˆëŠ” ìƒíƒœë¡œ)
      - name: Build with PyInstaller
        shell: pwsh
        run: |
          Write-Host "=== Building EXE ==="
          pyinstaller --onefile `
            --windowed `
            --name "ezSLauncher" `
            --clean `
            --uac-admin `
            --version-file "version_info.txt" `
            --icon "icon\icon.ico" `
            --add-data "icon\icon_title.ico;icon" `
            "ezSLauncher.py"
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "PyInstaller failed!"
            exit 1
          }

      # ResourceHackerë¡œ ì•„ì´ì½˜ ê°•ì œ ì£¼ì…
      - name: Inject icon with ResourceHacker
        shell: pwsh
        run: |
          Write-Host "=== Injecting icon with ResourceHacker ==="
          
          $exePath = "dist\ezSLauncher.exe"
          $iconPath = "icon\icon.ico"
          $rhPath = "ResourceHacker\ResourceHacker.exe"
          
          if (-not (Test-Path $exePath)) {
            Write-Host "[ERROR] EXE not found: $exePath"
            exit 1
          }
          
          if (-not (Test-Path $iconPath)) {
            Write-Host "[ERROR] Icon not found: $iconPath"
            exit 1
          }
          
          # ë°±ì—… ìƒì„±
          Copy-Item $exePath "$exePath.bak"
          
          # ResourceHackerë¡œ ì•„ì´ì½˜ êµì²´
          # -open: ì—´ íŒŒì¼
          # -save: ì €ì¥í•  íŒŒì¼
          # -action: addoverwrite (ë®ì–´ì“°ê¸°)
          # -res: ë¦¬ì†ŒìŠ¤ íŒŒì¼ (ì•„ì´ì½˜)
          # -mask: ICONGROUP,MAINICON, (ë©”ì¸ ì•„ì´ì½˜)
          & $rhPath -open $exePath -save $exePath -action addoverwrite -res $iconPath -mask ICONGROUP,MAINICON,
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host "[SUCCESS] Icon injected successfully!"
            Remove-Item "$exePath.bak"
          } else {
            Write-Host "[WARNING] ResourceHacker failed, restoring backup"
            Move-Item "$exePath.bak" $exePath -Force
          }

      # ë¹Œë“œëœ EXE í™•ì¸
      - name: Verify EXE
        shell: pwsh
        run: |
          if (Test-Path "dist/ezSLauncher.exe") {
            $exeFile = Get-Item "dist/ezSLauncher.exe"
            Write-Host "=== EXE Build Complete ==="
            Write-Host "File size: $($exeFile.Length) bytes"
            Write-Host "Created: $($exeFile.CreationTime)"
          } else {
            Write-Host "[ERROR] EXE file not found!"
            exit 1
          }

      # VirusTotal ìŠ¤ìº” ê²°ê³¼ URL ìƒì„±
      - name: Generate file hash
        shell: pwsh
        run: |
          $hash = Get-FileHash -Path "dist/ezSLauncher.exe" -Algorithm SHA256
          Write-Host "SHA256: $($hash.Hash)"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "## Build Info`n- SHA256: ``$($hash.Hash)```n- [VirusTotal Scan](https://www.virustotal.com/gui/file/$($hash.Hash))"

      # ë¦´ë¦¬ìŠ¤ íŒ¨í‚¤ì§€ ì¤€ë¹„
      - name: Prepare release package
        shell: pwsh
        run: |
          mkdir release
          Copy-Item dist/ezSLauncher.exe release/
          
          if (Test-Path "README.md") { Copy-Item README.md release/ }
          if (Test-Path "LICENSE") { Copy-Item LICENSE release/ }
          
          Compress-Archive -Path release/* -DestinationPath ezSLauncher.zip -Force

      # GitHub Release ìƒì„±
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.vars.outputs.base_version }}
          name: Release ${{ steps.vars.outputs.release_name }}
          body: |
            ğŸ“¦ Release Information

            Main Program: **ezSLauncher.exe.zip**  
            â†’ Contains executable file (ezSLauncher.exe) with icon

            ## Installation
            1. Download ezSLauncher.zip
            2. Extract the archive
            3. Run ezSLauncher.exe

            ## Notes
            - Windows Defender may show a warning
            - Administrator privileges required
            - Icon applied using ResourceHacker
            - This is open-source software

            ## SHA256 Hash
            Check file integrity after download
          files: |
            ezSLauncher.zip
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}