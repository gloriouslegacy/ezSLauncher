name: Build and Release (PKG Error Fixed)

on:
  push:
    branches:
      - main
    tags:
      - "v*"

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # íƒœê·¸ì—ì„œ ë²„ì „ ì¶”ì¶œ
      - name: Determine version
        id: vars
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            base_version="${GITHUB_REF#refs/tags/v}"
            version="$base_version"
            release_name="$base_version"
          else
            version="0.0.0-dev-$(date +%Y%m%d)"
            base_version="0.0.0-dev"
            release_name="$version"
          fi
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "base_version=$base_version" >> $GITHUB_OUTPUT
          echo "release_name=$release_name" >> $GITHUB_OUTPUT

      # Python ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt
        shell: pwsh

      # ì•„ì´ì½˜ íŒŒì¼ ì¡´ì¬ í™•ì¸
      - name: Check icon files
        shell: pwsh
        run: |
          Write-Host "=== Checking icon files ==="
          
          if (Test-Path "icon/icon.ico") {
            Write-Host "[OK] icon/icon.ico exists"
            $iconFile = Get-Item "icon/icon.ico"
            Write-Host "  Size: $($iconFile.Length) bytes"
          } else {
            Write-Host "[ERROR] icon/icon.ico NOT FOUND!"
            exit 1
          }
          
          if (Test-Path "icon/icon_title.ico") {
            Write-Host "[OK] icon/icon_title.ico exists"
          }

      # version_info.txt ìƒì„±
      - name: Generate version_info.txt
        shell: pwsh
        run: |
          $version = "${{ steps.vars.outputs.version }}"
          $versionParts = $version -replace '-.*','' -split '\.'
          
          while ($versionParts.Count -lt 3) {
            $versionParts += "0"
          }
          
          $filevers = "($($versionParts[0]), $($versionParts[1]), $($versionParts[2]), 0)"
          $versionStr = "$($versionParts[0]).$($versionParts[1]).$($versionParts[2])"
          
          $versionInfo = @"
          # UTF-8ë¡œ ì €ì¥
          
          VSVersionInfo(
            ffi=FixedFileInfo(
              filevers=$filevers,
              prodvers=$filevers,
              mask=0x3f,
              flags=0x0,
              OS=0x40004,
              fileType=0x1,
              subtype=0x0,
              date=(0, 0)
              ),
            kids=[
              StringFileInfo(
                [
                StringTable(
                  u'041204B0',
                  [
                  StringStruct(u'Comments', u''),
                  StringStruct(u'CompanyName', u'ez'),
                  StringStruct(u'FileDescription', u'ezSLauncher'),
                  StringStruct(u'FileVersion', u'$versionStr'),
                  StringStruct(u'InternalName', u'ezSLauncher.exe'),
                  StringStruct(u'LegalCopyright', u'Copyright Â© 2025 ez All rights reserved.'),
                  StringStruct(u'LegalTrademarks', u''),
                  StringStruct(u'OriginalFilename', u'ezSLauncher.exe'),
                  StringStruct(u'ProductName', u'ezSLauncher'),
                  StringStruct(u'ProductVersion', u'$versionStr'),
                  StringStruct(u'SpecialBuild', u'')
                  ]
                )
                ]
              ),
              VarFileInfo([VarStruct(u'Translation', [0x0412, 1200])])
            ]
          )
          "@
          
          $versionInfo | Out-File -FilePath "version_info.txt" -Encoding UTF8

      # .spec íŒŒì¼ ìƒì„± (UPX ë¹„í™œì„±í™” ë° ì•„ì´ì½˜ ê²½ë¡œ ëª…ì‹œ)
      - name: Generate spec file
        shell: pwsh
        run: |
          $currentDir = (Get-Location).Path
          $iconPath = Join-Path $currentDir "icon\icon.ico"
          $iconTitlePath = Join-Path $currentDir "icon\icon_title.ico"
          
          # ê²½ë¡œë¥¼ PyInstallerê°€ ì¸ì‹í•  ìˆ˜ ìˆë„ë¡ ë³€í™˜ (ë°±ìŠ¬ë˜ì‹œë¥¼ ì´ì¤‘ ë°±ìŠ¬ë˜ì‹œë¡œ)
          $iconPathEscaped = $iconPath -replace '\\', '\\\\'
          $iconTitlePathEscaped = $iconTitlePath -replace '\\', '\\\\'
          
          Write-Host "Generating spec file..."
          Write-Host "Icon path: $iconPath"
          Write-Host "Icon title path: $iconTitlePath"
          
          $specContent = @"
          # -*- mode: python ; coding: utf-8 -*-

          block_cipher = None

          a = Analysis(
              ['ezSLauncher.py'],
              pathex=[],
              binaries=[],
              datas=[('$iconTitlePathEscaped', 'icon')],
              hiddenimports=[],
              hookspath=[],
              hooksconfig={},
              runtime_hooks=[],
              excludes=[],
              win_no_prefer_redirects=False,
              win_private_assemblies=False,
              cipher=block_cipher,
              noarchive=False,
          )

          pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

          exe = EXE(
              pyz,
              a.scripts,
              a.binaries,
              a.zipfiles,
              a.datas,
              [],
              name='ezSLauncher',
              debug=False,
              bootloader_ignore_signals=False,
              strip=False,
              upx=False,
              upx_exclude=[],
              runtime_tmpdir=None,
              console=False,
              disable_windowed_traceback=False,
              argv_emulation=False,
              target_arch=None,
              codesign_identity=None,
              entitlements_file=None,
              version='version_info.txt',
              uac_admin=True,
              icon='$iconPathEscaped',
          )
          "@
          
          $specContent | Out-File -FilePath "ezSLauncher.spec" -Encoding UTF8
          
          Write-Host "`n=== Generated spec file content ==="
          Get-Content "ezSLauncher.spec" | Write-Host

      # PyInstallerë¡œ ë¹Œë“œ (spec íŒŒì¼ ì‚¬ìš©)
      - name: Build with PyInstaller
        shell: pwsh
        run: |
          Write-Host "=== Building with PyInstaller ==="
          
          # spec íŒŒì¼ì„ ì‚¬ìš©í•˜ì—¬ ë¹Œë“œ
          pyinstaller ezSLauncher.spec --clean --log-level=INFO
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "[ERROR] PyInstaller failed with exit code: $LASTEXITCODE"
            exit 1
          }
          
          Write-Host "[SUCCESS] Build completed successfully"

      # ë¹Œë“œëœ EXE ê²€ì¦
      - name: Verify EXE
        shell: pwsh
        run: |
          Write-Host "=== Verifying build output ==="
          
          if (Test-Path "dist/ezSLauncher.exe") {
            $exeFile = Get-Item "dist/ezSLauncher.exe"
            Write-Host "[SUCCESS] EXE file created"
            Write-Host "  Name: $($exeFile.Name)"
            Write-Host "  Size: $($exeFile.Length) bytes ($([math]::Round($exeFile.Length/1MB, 2)) MB)"
            Write-Host "  Created: $($exeFile.CreationTime)"
            Write-Host "  Modified: $($exeFile.LastWriteTime)"
            
            # íŒŒì¼ì´ ë„ˆë¬´ ì‘ìœ¼ë©´ ê²½ê³ 
            if ($exeFile.Length -lt 1MB) {
              Write-Host "[WARNING] EXE file is suspiciously small!"
            }
          } else {
            Write-Host "[ERROR] EXE file not found in dist directory!"
            Write-Host "`nContents of dist directory:"
            if (Test-Path "dist") {
              Get-ChildItem dist -Recurse | Format-Table Name, Length, FullName
            } else {
              Write-Host "dist directory does not exist"
            }
            exit 1
          }

      # ê°„ë‹¨í•œ ì‹¤í–‰ í…ŒìŠ¤íŠ¸ (ë¹ ë¥¸ ì¢…ë£Œ ì˜µì…˜ ìˆë‹¤ë©´)
      - name: Test EXE execution
        shell: pwsh
        continue-on-error: true
        run: |
          Write-Host "=== Testing EXE (basic check) ==="
          
          # EXEê°€ ë¡œë“œë˜ëŠ”ì§€ë§Œ í™•ì¸ (GUI í”„ë¡œê·¸ë¨ì´ë¯€ë¡œ ë°”ë¡œ ì¢…ë£Œí•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ)
          $process = Start-Process -FilePath "dist\ezSLauncher.exe" -PassThru -WindowStyle Hidden
          Start-Sleep -Seconds 2
          
          if (-not $process.HasExited) {
            Write-Host "[OK] EXE loaded successfully (process is running)"
            Stop-Process -Id $process.Id -Force
          } else {
            $exitCode = $process.ExitCode
            if ($exitCode -eq 0) {
              Write-Host "[OK] EXE executed and exited normally"
            } else {
              Write-Host "[WARNING] EXE exited with code: $exitCode"
            }
          }

      # VirusTotal í•´ì‹œ ìƒì„±
      - name: Generate file hash
        shell: pwsh
        run: |
          $hash = Get-FileHash -Path "dist/ezSLauncher.exe" -Algorithm SHA256
          Write-Host "SHA256: $($hash.Hash)"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "## Build Info`n- SHA256: ``$($hash.Hash)```n- [VirusTotal Scan](https://www.virustotal.com/gui/file/$($hash.Hash))"

      # ë¹Œë“œ ì‚°ì¶œë¬¼ ëª©ë¡
      - name: List build output
        shell: pwsh
        run: |
          Write-Host "=== Build artifacts ==="
          if (Test-Path "dist") {
            Get-ChildItem dist -Recurse | Format-Table Name, Length, FullName -AutoSize
          }
          if (Test-Path "build") {
            Write-Host "`n=== Build directory (temporary) ==="
            Get-ChildItem build -Recurse | Select-Object -First 20 | Format-Table Name, Length
          }

      # ë¦´ë¦¬ìŠ¤ íŒ¨í‚¤ì§€ ì¤€ë¹„
      - name: Prepare release package
        shell: pwsh
        run: |
          Write-Host "=== Preparing release package ==="
          
          mkdir release -Force
          Copy-Item dist/ezSLauncher.exe release/
          
          # ì¶”ê°€ íŒŒì¼ í¬í•¨
          if (Test-Path "README.md") {
            Write-Host "Including README.md"
            Copy-Item README.md release/
          }
          if (Test-Path "LICENSE") {
            Write-Host "Including LICENSE"
            Copy-Item LICENSE release/
          }
          
          # ZIP ìƒì„±
          Compress-Archive -Path release/* -DestinationPath ezSLauncher.zip -Force
          
          $zipFile = Get-Item ezSLauncher.zip
          Write-Host "[SUCCESS] Release package created"
          Write-Host "  File: $($zipFile.Name)"
          Write-Host "  Size: $($zipFile.Length) bytes ($([math]::Round($zipFile.Length/1MB, 2)) MB)"

      # GitHub Release ìƒì„±
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.vars.outputs.base_version }}
          name: Release ${{ steps.vars.outputs.release_name }}
          body: |
            ğŸ“¦ **ezSLauncher Release**

            ## ğŸ“¥ Download
            - **ezSLauncher.zip** - Main program (extract and run)

            ## ğŸš€ Installation
            1. Download `ezSLauncher.zip`
            2. Extract the archive
            3. Run `ezSLauncher.exe`

            ## âš ï¸ Important Notes
            - **Windows Defender Warning**: May show SmartScreen warning (normal for unsigned executables)
              - Click "More info" â†’ "Run anyway"
            - **Administrator Privileges**: Required for some features
            - **First Run**: May take a few seconds to initialize

            ## ğŸ”§ Technical Details
            - Built with PyInstaller (no UPX compression)
            - Icon embedded in executable
            - Windows 10/11 compatible

            ## ğŸ”’ Security
            - Open source - code available in repository
            - Check SHA256 hash after download
            - Scan with VirusTotal if desired

            ## ğŸ“ SHA256 Hash
            Verify file integrity after download

            ## ğŸ› Issues?
            Report any problems in the GitHub Issues section
          files: |
            ezSLauncher.zip
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}