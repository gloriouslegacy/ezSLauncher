name: Build and Release

on:
  push:
    branches:
      - main
    tags:
      - "v*"

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # íƒœê·¸ì—ì„œ ë²„ì „ ì¶”ì¶œ
      - name: Determine version
        id: vars
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            base_version="${GITHUB_REF#refs/tags/v}"
            version="$base_version"
            release_name="$base_version"
          else
            version="0.0.0-dev-$(date +%Y%m%d)"
            base_version="0.0.0-dev"
            release_name="$version"
          fi
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "base_version=$base_version" >> $GITHUB_OUTPUT
          echo "release_name=$release_name" >> $GITHUB_OUTPUT

      # ì•„ì´ì½˜ íŒŒì¼ ì¡´ì¬ í™•ì¸ (ë””ë²„ê¹…)
      - name: Verify icon files
        shell: pwsh
        run: |
          Write-Host "=== Icon Files Check ==="
          if (Test-Path "./icon/icon.ico") {
            Write-Host "âœ“ icon.ico found"
            $iconSize = (Get-Item "./icon/icon.ico").Length
            Write-Host "  Size: $iconSize bytes"
          } else {
            Write-Host "âœ— icon.ico NOT found"
            exit 1
          }
          
          if (Test-Path "./icon/icon_title.ico") {
            Write-Host "âœ“ icon_title.ico found"
          } else {
            Write-Host "âœ— icon_title.ico NOT found"
          }
          
          Write-Host "`n=== Directory Structure ==="
          Get-ChildItem -Path . -Recurse -Include *.ico | ForEach-Object {
            Write-Host "  $($_.FullName)"
          }

      # Python ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          if (Test-Path "requirements.txt") {
            pip install -r requirements.txt
          }
        shell: pwsh

      # version_info.txt ìƒì„± (ë²„ì „ ìë™ ì—…ë°ì´íŠ¸)
      - name: Generate version_info.txt
        shell: pwsh
        run: |
          $version = "${{ steps.vars.outputs.version }}"
          $versionParts = $version -replace '-.*','' -split '\.'
          
          # ë²„ì „ì„ 3ìë¦¬ë¡œ ë§ì¶”ê¸° (ì˜ˆ: 1.0 -> 1.0.0)
          while ($versionParts.Count -lt 3) {
            $versionParts += "0"
          }
          
          # fileversëŠ” 4ìë¦¬ í•„ìš” (Windows ìš”êµ¬ì‚¬í•­)
          $filevers = "($($versionParts[0]), $($versionParts[1]), $($versionParts[2]), 0)"
          # í‘œì‹œìš© ë²„ì „ì€ 3ìë¦¬
          $versionStr = "$($versionParts[0]).$($versionParts[1]).$($versionParts[2])"
          
          $versionInfo = @"
          # UTF-8ë¡œ ì €ì¥
          
          VSVersionInfo(
            ffi=FixedFileInfo(
              # íŒŒì¼ ë²„ì „
              filevers=$filevers,
              # ì œí’ˆ ë²„ì „
              prodvers=$filevers,
              mask=0x3f,
              flags=0x0,
              OS=0x40004,
              fileType=0x1,
              subtype=0x0,
              date=(0, 0)
              ),
            kids=[
              StringFileInfo(
                [
                StringTable(
                  u'041204B0',
                  [
                  StringStruct(u'Comments', u''),
                  StringStruct(u'CompanyName', u'ez'),
                  StringStruct(u'FileDescription', u'ezSLauncher'),
                  StringStruct(u'FileVersion', u'$versionStr'),
                  StringStruct(u'InternalName', u'ezSLauncher.exe'),
                  StringStruct(u'LegalCopyright', u'Copyright Â© 2025 ez All rights reserved.'),
                  StringStruct(u'LegalTrademarks', u''),
                  StringStruct(u'OriginalFilename', u'ezSLauncher.exe'),
                  StringStruct(u'ProductName', u'ezSLauncher'),
                  StringStruct(u'ProductVersion', u'$versionStr'),
                  StringStruct(u'SpecialBuild', u'')
                  ]
                )
                ]
              ),
              VarFileInfo([VarStruct(u'Translation', [0x0412, 1200])])
            ]
          )
          "@
          
          $versionInfo | Out-File -FilePath "version_info.txt" -Encoding UTF8
          
          Write-Host "=== Generated version_info.txt ==="
          Get-Content "version_info.txt"

      # PyInstallerë¡œ ë¹Œë“œ (BAT íŒŒì¼ê³¼ ë™ì¼í•œ ìˆœì„œ)
      - name: Build with PyInstaller
        shell: pwsh
        run: |
          Write-Host "=== Starting PyInstaller Build ==="
          
          # ìƒëŒ€ ê²½ë¡œë¡œ ì•„ì´ì½˜ ì§€ì • (Unix ìŠ¤íƒ€ì¼ ê²½ë¡œ êµ¬ë¶„ì ì‚¬ìš©)
          $iconPath = "icon/icon.ico"
          Write-Host "Icon path: $iconPath"
          Write-Host "Icon exists: $(Test-Path 'icon\icon.ico')"
          
          # PyInstaller ì‹¤í–‰ - ìƒëŒ€ ê²½ë¡œì™€ ìŠ¬ë˜ì‹œ(/) ì‚¬ìš©
          pyinstaller --onefile `
            --windowed `
            --name "ezSLauncher" `
            --clean `
            --uac-admin `
            --version-file "version_info.txt" `
            --icon="icon/icon.ico" `
            --add-data "icon/icon_title.ico;icon" `
            ezSLauncher.py
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "âŒ PyInstaller build failed with exit code $LASTEXITCODE"
            exit 1
          }
          
          Write-Host "âœ“ PyInstaller build completed"

      # ë¹Œë“œëœ EXEì˜ ì•„ì´ì½˜ í™•ì¸
      - name: Verify built executable icon
        shell: pwsh
        run: |
          Write-Host "=== Verifying Built Executable ==="
          
          if (Test-Path "dist/ezSLauncher.exe") {
            $exeSize = (Get-Item "dist/ezSLauncher.exe").Length
            Write-Host "âœ“ EXE file created"
            Write-Host "  Size: $exeSize bytes"
            
            # PE ë¦¬ì†ŒìŠ¤ ì„¹ì…˜ì—ì„œ ì•„ì´ì½˜ í™•ì¸
            try {
              Add-Type -AssemblyName System.Drawing
              $icon = [System.Drawing.Icon]::ExtractAssociatedIcon("$PWD\dist\ezSLauncher.exe")
              if ($icon) {
                Write-Host "âœ“ Icon successfully extracted from EXE"
                Write-Host "  Icon size: $($icon.Width)x$($icon.Height)"
                $icon.Dispose()
              } else {
                Write-Host "âš  No icon found in EXE"
              }
            } catch {
              Write-Host "âš  Could not extract icon: $($_.Exception.Message)"
            }
            
            # ë°”ì´íŠ¸ ë ˆë²¨ ê²€ì‚¬ - ICO ì‹œê·¸ë‹ˆì²˜ í™•ì¸
            $bytes = [System.IO.File]::ReadAllBytes("dist/ezSLauncher.exe")
            $hasIcon = $false
            
            for ($i = 0; $i -lt $bytes.Length - 4; $i++) {
              if ($bytes[$i] -eq 0x00 -and $bytes[$i+1] -eq 0x00 -and 
                  $bytes[$i+2] -eq 0x01 -and $bytes[$i+3] -eq 0x00) {
                $hasIcon = $true
                Write-Host "âœ“ ICO signature found at offset: $i"
                break
              }
            }
            
            if (-not $hasIcon) {
              Write-Host "âš  WARNING: ICO signature not found in executable"
              Write-Host "  This may indicate the icon was not properly embedded"
            }
          } else {
            Write-Host "âŒ EXE file not found"
            exit 1
          }

      # íŒŒì¼ í•´ì‹œ ìƒì„±
      - name: Generate file hash
        shell: pwsh
        run: |
          $hash = Get-FileHash -Path "dist/ezSLauncher.exe" -Algorithm SHA256
          Write-Host "SHA256: $($hash.Hash)"
          Write-Host "VirusTotal URL: https://www.virustotal.com/gui/file/$($hash.Hash)"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "## Build Info`n- SHA256: ``$($hash.Hash)```n- [VirusTotal Scan](https://www.virustotal.com/gui/file/$($hash.Hash))"

      # ë¹Œë“œ ê²°ê³¼ í™•ì¸ (ë””ë²„ê¹…ìš©)
      - name: List build output
        shell: pwsh
        run: |
          Write-Host "=== Build Output ==="
          Get-ChildItem dist -Recurse | Format-Table Name, Length, FullName
          
          Write-Host "`n=== Spec File Check ==="
          if (Test-Path "ezSLauncher.spec") {
            Write-Host "Generated spec file:"
            Get-Content "ezSLauncher.spec"
          }

      # ë¦´ë¦¬ìŠ¤ íŒ¨í‚¤ì§€ ì¤€ë¹„
      - name: Prepare release package
        shell: pwsh
        run: |
          mkdir release
          Copy-Item dist/ezSLauncher.exe release/
          
          # í•„ìš”í•œ ê²½ìš° ì¶”ê°€ íŒŒì¼ ë³µì‚¬ (ì˜ˆ: README, LICENSE ë“±)
          if (Test-Path "README.md") { Copy-Item README.md release/ }
          if (Test-Path "LICENSE") { Copy-Item LICENSE release/ }
          
          # ZIP íŒŒì¼ ìƒì„±
          Compress-Archive -Path release/* -DestinationPath ezSLauncher.zip -Force

      # GitHub Release ìƒì„±
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.vars.outputs.base_version }}
          name: Release ${{ steps.vars.outputs.release_name }}
          body: |
            # ğŸ“¦ ezSLauncher v${{ steps.vars.outputs.release_name }}

            ## ğŸ“¥ Download & Install
            
            1. **Download** `ezSLauncher.zip`
            2. **Extract** all files
            3. **Run** `ezSLauncher.exe`

            ## âœ¨ What's Fixed
            
            - âœ… **PKG Archive Error**: Fixed by disabling UPX compression
            - âœ… **Icon Display**: Icon properly embedded in executable
            - âœ… **Stability**: Improved build process with verification steps

            ## âš ï¸ First Run

            Windows Defender or SmartScreen may show a warning:
            
            1. Click **"More info"**
            2. Click **"Run anyway"**
            
            This is normal for new/unsigned executables. The program is safe and open source.

            ## ğŸ”’ Security

            - **Open Source**: Full source code available in this repository
            - **SHA256 Hash**: See below to verify file integrity
            - **VirusTotal**: Scan link provided in build summary
            - **No Telemetry**: This software does not collect any data

            ## ğŸ’» System Requirements

            - Windows 10 or Windows 11
            - Administrator privileges (for some features)
            - ~20MB free disk space

            ## ğŸ› Known Issues

            None currently. Please report any issues on GitHub!

            ## ğŸ“ Changelog

            See commit history for detailed changes.

            ---

          files: |
            ezSLauncher.zip
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}